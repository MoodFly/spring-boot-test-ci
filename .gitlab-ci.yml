default:
  image: '3.6.3-openjdk-8'

stages:
  - prepare
  - test
  - analysis

#prepare:
#  stage: prepare
#  cache:
#    key: m_m2
#    paths:
#      - .m2/repository/
#  script:
#    - mvn -v && java -version
##    - mvn clean install -P skipTests -s settings.xml
#  tags:
#    - SHARE_MAVEN_JDK

tests:
  stage: test
  cache:
    key: m_m2
    policy: pull-push
    paths:
      - .m2/repository/
  script:
    - mvn -v && java -version
    - mvn clean install -P tests -s settings.xml
  artifacts:
    when: on_success
    paths:
      - target/failsafe-reports
      - target/surefire-reports
      - target/classes
      - target/test-classes
      - target/site
      - target/*.exec
  coverage: '/Code coverage: \d+\.\d+/'
  tags:
    - SHARE_MAVEN_JDK

analysis:
  stage: analysis
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: ['']
  cache:
    key: m_m2
    policy: pull
    paths:
      - ./target
  variables:
    SONAR_TOKEN: '67296badea93b1a60d324330852a6256a1fec8b4'
    SONAR_HOST_URL: "http://10.222.225.17:9000"
    GIT_DEPTH: 0
    SONAR_PROJECT_BASE_DIR: ./
  script:
    - pwd
    - ls -l
    - sonar-scanner -Dsonar.qualitygate.wait=true
  tags:
    - SONAR_SCANNER
  only:
    - master
